name: Release Promotion

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  promote-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Pull RC Image
      run: docker pull ${{ secrets.DOCKER_USERNAME }}/chuzone-poc:1.0.0-RC1
      
    - name: Tag as Stable
      run: docker tag ${{ secrets.DOCKER_USERNAME }}/chuzone-poc:1.0.0-RC1 ${{ secrets.DOCKER_USERNAME }}/chuzone-poc:1.0.0
      
    - name: Push Stable Image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/chuzone-poc:1.0.0
      
    - name: Create Git Tag
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/v1.0.0',
            sha: context.sha
          })
